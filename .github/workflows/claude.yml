name: Claude Code Review

on:
  # Automatically review new PRs
  pull_request:
    types: [opened, synchronize]

  # Respond to @claude mentions in comments
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  claude-review:
    # Run on new PRs OR when @claude is mentioned
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: '@claude'
          mode: tag
          timeout_minutes: 30
          custom_instructions: |
            When reviewing a new PR:
            1. Provide a concise summary of what the PR does
            2. Highlight key changes and their impact
            3. Check for potential security issues
            4. Look for architectural concerns
            5. Verify code quality and best practices

            Keep your initial review focused and actionable.
